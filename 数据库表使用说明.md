# 热榜聚合系统数据库表使用说明

## 概述

本文档说明热榜聚合系统中各个数据库表的用途、使用场景和时机。系统包含原始数据表和聚合分析表两类。

## 核心使用表（您已经在使用的）

### 1. hot_aggr_events
**表名**: `hot_aggr_events`
**用途**: 事件主表，存储聚合生成的热点事件
**使用时机**:
- **每2小时**: 定时任务执行事件聚合时创建新事件
- **实时**: 通过main_processor.py处理新闻聚合时写入
- **API调用**: 手动触发聚合流程时

**使用场景**:
- 主处理流程: `main_processor.py` → `event_aggregation_service.py` → 写入此表
- 查询最近事件进行历史关联分析
- 提供给前端展示热点事件列表

### 2. hot_aggr_news_processing_status
**表名**: `hot_aggr_news_processing_status`
**用途**: 新闻处理状态跟踪表
**使用时机**:
- **每次处理前**: 标记新闻为`processing`状态
- **处理完成后**: 标记为`completed`或`failed`
- **重试机制**: 更新重试次数和错误信息

**使用场景**:
- 防止重复处理同一条新闻
- 跟踪处理进度和失败原因
- 支持断点续传和错误恢复

## 关联表（当前主要业务使用）

### 3. hot_aggr_news_event_relations
**表名**: `hot_aggr_news_event_relations`
**用途**: 新闻和事件的多对多关联关系
**使用时机**:
- **聚合时**: 将相关新闻关联到创建的事件
- **查询时**: 通过事件ID查找相关新闻，或通过新闻ID查找所属事件

**使用场景**:
- 事件详情页面显示相关新闻列表
- 新闻去重：检查新闻是否已被关联到事件
- 统计事件的新闻数量

## 扩展功能表（未来使用场景）

### 4. hot_aggr_event_labels
**表名**: `hot_aggr_event_labels`
**用途**: 事件标签和分类信息
**预计使用时机**:
- **标签分析任务**: 每小时执行一次，对新事件进行标签提取
- **手动标注**: 运营人员手动添加标签
- **规则引擎**: 基于关键词自动打标签

**应用场景**:
- 事件分类和过滤（如娱乐、体育事件过滤）
- 情感分析结果存储
- 实体识别结果（人物、组织、地点）
- 用户个性化推荐的基础数据

### 5. hot_aggr_event_history_relations
**表名**: `hot_aggr_event_history_relations`
**用途**: 事件历史关联关系（事件演化、延续、合并）
**预计使用时机**:
- **历史分析任务**: 周期性（如每天）分析事件间的时间关系
- **事件合并**: 发现相似事件时建立合并关系
- **追踪延续**: 同一话题的事件发展轨迹

**应用场景**:
- 构建事件时间线和发展脉络
- 事件影响力分析
- 热点话题的生命周期追踪
- 相关事件推荐

### 6. hot_aggr_processing_logs
**表名**: `hot_aggr_processing_logs`
**用途**: 系统处理日志和统计信息
**使用时机**:
- **每次批处理**: 记录开始、结束时间和处理结果
- **错误追踪**: 记录失败原因和错误详情
- **性能监控**: 记录处理耗时和资源使用

**应用场景**:
- 系统监控面板数据源
- 性能优化分析
- 错误调试和问题排查
- 处理量统计和报表

## 原始数据表

### hot_news_base
**表名**: `hot_news_base`
**用途**: 原始热点新闻数据存储
**数据来源**: 外部爬虫或API接口
**使用时机**:
- **读取**: 每次聚合任务时作为数据源
- **关联**: 通过news_id与聚合表建立关联

## 使用流程时机图

```
定时任务 (每2小时)
    ↓
main_processor.py
    ↓
1. 查询 hot_news_base (数据源)
    ↓
2. 检查 hot_aggr_news_processing_status (避免重复)
    ↓
3. 写入 hot_aggr_news_processing_status (标记处理中)
    ↓
4. AI聚合处理
    ↓
5. 创建 hot_aggr_events (生成事件)
    ↓
6. 创建 hot_aggr_news_event_relations (建立关联)
    ↓
7. 更新 hot_aggr_news_processing_status (标记完成)
    ↓
8. 记录 hot_aggr_processing_logs (处理日志)

可选扩展流程:
    ↓
9. 分析 hot_aggr_event_labels (标签提取)
    ↓
10. 建立 hot_aggr_event_history_relations (历史关联)
```

## 表的重要性等级

**核心必须表** (当前使用):
- ✅ hot_news_base - 数据源
- ✅ hot_aggr_events - 核心业务表
- ✅ hot_aggr_news_processing_status - 状态控制
- ✅ hot_aggr_news_event_relations - 关联关系

**扩展功能表** (可选使用):
- 📊 hot_aggr_processing_logs - 运维监控用
- 🏷️ hot_aggr_event_labels - 标签分析用
- 🔗 hot_aggr_event_history_relations - 高级分析用

## 建议使用时机

1. **立即启用**:
   - hot_aggr_processing_logs：建议在当前流程中加入日志记录

2. **短期规划** (1-2周):
   - hot_aggr_event_labels：实现基础的标签功能

3. **中期规划** (1-2月):
   - hot_aggr_event_history_relations：实现事件关联分析

## 注意事项

1. **数据一致性**: 当前系统使用无外键约束设计，需要业务层保证数据一致性
2. **性能考虑**: 大批量处理时注意索引使用，已建立必要的复合索引
3. **扩展性**: 表结构支持JSON字段存储复杂数据，便于功能扩展
