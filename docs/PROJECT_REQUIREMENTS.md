# 热榜聚合智能体项目需求文档

## 项目概述
热榜聚合智能体是一个基于Python的智能新闻事件聚合系统，主要功能是将大量新闻标题聚合成事件，并进行多维度标签分析。

## 核心需求

### 1. 功能需求
- **新闻聚合**: 将相关新闻聚合成事件，确保无遗漏
- **历史关联**: 新事件与历史事件进行关联分析
- **多维标签**: 对事件进行正反面、实体、地域、新闻类型等标签分析
- **内容过滤**: 去除娱乐、体育类新闻
- **定时处理**: 支持定时任务，处理增量数据

### 2. 技术需求
- **开发语言**: Python
- **包管理**: 使用uv管理依赖，建立.venv虚拟环境
- **数据库**: MySQL，基于现有hot_news_base表
- **大模型**: 使用OpenAI格式API进行智能分析
- **日志系统**: loguru，同时输出到文件和控制台
- **配置管理**: .env文件管理敏感信息
- **架构要求**: 高内聚低耦合，模块化设计

### 3. 性能需求
- **数据规模**: 初期几百条，后期几千条新闻
- **并发处理**: 支持并发调用大模型API
- **重试机制**: 处理API限流和临时错误
- **错误处理**: 完善的错误处理，避免程序崩溃

### 4. 扩展需求
- **API接口**: 提供REST API用于测试和监控
- **监控功能**: 处理进度跟踪和状态监控
- **未来扩展**: 预留Kafka、Elasticsearch、更多API接口的扩展空间

## 技术架构

### 1. 模块划分
- **config**: 配置管理模块
- **database**: 数据库操作模块
- **models**: 数据模型定义
- **services**: 业务服务层
  - news_service: 新闻处理服务
  - event_service: 事件聚合服务
  - labeling_service: 标签分析服务
  - ai_service: 大模型调用封装
- **utils**: 工具函数模块
- **api**: REST API接口
- **schedulers**: 定时任务调度
- **tests**: 测试模块

### 2. 数据库设计
基于现有hot_news_base表，新增以下表：
- **events**: 事件主表
- **news_event_relations**: 新闻事件关联表
- **event_labels**: 事件标签表
- **event_history_relations**: 事件历史关联表
- **processing_logs**: 处理日志表

### 3. 工作流程
1. **数据获取**: 从hot_news_base表批量获取未处理新闻
2. **事件聚合**: 使用大模型分析新闻相似性，聚合成事件
3. **历史关联**: 将新事件与历史事件进行关联
4. **标签分析**: 多维度标签分析（情感、实体、地域、类型）
5. **内容过滤**: 过滤娱乐、体育类新闻
6. **结果存储**: 存储处理结果到数据库

## 关键技术点

### 1. 大模型调用封装
- 统一的OpenAI格式接口
- 指数退避重试机制
- 并发控制和限流
- 上下文长度管理
- 缓存机制

### 2. 错误处理
- 自定义异常类
- 分类错误处理
- 详细错误日志
- 优雅降级

### 3. 并发处理
- asyncio异步处理
- 信号量控制并发数
- 批处理优化
- 进度跟踪

### 4. 定时任务
- APScheduler任务调度
- 增量处理机制
- 任务状态监控
- 优雅停机

## 实施计划

### 第一阶段：基础搭建
- [x] 项目需求分析
- [ ] 环境配置和依赖管理
- [ ] 数据库表设计
- [ ] 基础项目结构
- [ ] 配置管理系统

### 第二阶段：核心功能
- [ ] 数据库操作模块
- [ ] 大模型调用封装
- [ ] 新闻聚合服务
- [ ] 标签分析服务

### 第三阶段：高级功能
- [ ] 历史事件关联
- [ ] 并发处理优化
- [ ] 定时任务调度
- [ ] 错误处理完善

### 第四阶段：监控优化
- [ ] REST API接口
- [ ] 监控面板
- [ ] 性能优化
- [ ] 文档完善

## 质量保证
- 单元测试覆盖
- 集成测试
- API测试
- 性能测试
- 代码审查

## 文档要求
- 详细的README.md
- API文档
- 部署文档
- 开发文档
- 用户手册

---
*文档创建时间: 2025-01-23*
*最后更新时间: 2025-01-23*