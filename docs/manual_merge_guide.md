# 手动合并功能使用指南

## 功能概述

手动合并功能允许您直接指定要合并的事件ID，跳过LLM智能分析步骤，直接执行事件合并操作。这个功能特别适用于：

- 🧪 **测试场景**：验证合并逻辑和数据完整性
- 🎯 **精确控制**：当您明确知道哪些事件需要合并时
- 🔧 **手动纠正**：修正自动分析可能遗漏的相关事件
- 📊 **批量处理**：处理特定的事件组合

## 基本用法

### 命令格式
```bash
python main_combine.py manual <事件ID1>,<事件ID2>[,<事件ID3>...]
```

### 使用示例

```bash
# 合并两个事件
python main_combine.py manual 367,397

# 合并多个事件
python main_combine.py manual 367,397,400

# 合并更多事件
python main_combine.py manual 1001,1002,1003,1004
```

## 执行流程

### 1. 参数解析
- 系统解析命令行参数中的事件ID列表
- 验证事件ID格式（必须为数字，用逗号分隔）
- 检查是否提供了至少2个事件ID

### 2. 事件验证
- 从数据库中查询指定的事件ID
- 验证事件是否存在且状态正常
- 显示找到的事件信息供用户确认

### 3. 确认提示
系统会显示以下信息供用户确认：
- 要合并的事件ID列表
- 主事件ID（第一个ID）
- 操作不可逆的警告
- 需要用户输入 'y' 或 'yes' 确认执行

### 4. 合并执行
- 创建手动合并建议（跳过LLM分析）
- 执行数据合并操作
- 更新事件状态和关联关系
- 记录合并历史

## 合并规则

### 主事件选择
- **第一个事件ID自动成为主事件**
- 主事件保留原有数据和状态
- 其他事件的数据合并到主事件中

### 数据融合策略
```python
# 标题融合：保持主事件标题
merged_title = primary_event['title']

# 关键词融合：合并所有事件的关键词
merged_keywords = list(set(all_keywords))

# 地区融合：合并所有事件的相关地区
merged_regions = list(set(all_regions))
```

### 状态更新
- 子事件状态更新为"merged"（已合并）
- 主事件状态保持不变
- 新闻关联关系转移到主事件

## 测试验证

### 使用测试脚本
推荐先使用测试脚本验证功能：

```bash
# 基础功能测试（无实际合并）
python test_scripts/test_manual_merge.py

# 简单测试（无交互）
python test_scripts/test_manual_merge_simple.py
```

### 验证检查项
- ✅ 事件ID有效性验证
- ✅ 手动合并建议创建
- ✅ 数据融合逻辑
- ✅ 错误处理机制

## 注意事项

### ⚠️ 重要警告
1. **不可逆操作**：事件合并后无法直接撤销
2. **数据完整性**：确保指定的事件ID存在且有效
3. **权限要求**：需要数据库写入权限
4. **历史记录**：所有合并操作会记录在`hot_aggr_event_history_relations`表中

### 最佳实践
1. **先测试**：在生产环境使用前先用测试脚本验证
2. **小批量**：建议每次合并少量事件，便于验证结果
3. **备份数据**：重要操作前建议备份相关数据
4. **检查结果**：合并后检查数据完整性和关联关系

## 错误处理

### 常见错误及解决方案

| 错误类型 | 原因 | 解决方案 |
|---------|------|----------|
| 解析事件ID失败 | ID格式不正确 | 确保ID为数字，用逗号分隔 |
| 事件不存在 | 指定的ID在数据库中不存在 | 检查ID的正确性 |
| 数据库连接失败 | 数据库配置或权限问题 | 检查数据库连接配置 |
| 合并执行失败 | 数据约束或其他数据库问题 | 查看详细错误日志 |

### 日志查看
合并过程的详细日志会输出到控制台和日志文件中，包括：
- 事件ID解析结果
- 事件验证状态
- 合并建议详情
- 执行结果统计

## 相关文件

- `main_combine.py:105-129` - 手动合并入口函数
- `services/event_combine_service.py` - 核心合并逻辑
- `test_scripts/test_manual_merge.py` - 功能测试脚本
- `scripts/create_history_table_simple.py` - 历史表创建脚本